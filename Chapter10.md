# Chapter 10. 파일 시스템

파일 시스템은 대부분의 사용자에게 가장 잘보이는 운영체제의 부분
관련된 자료를 저장하는 파일들의 모음과 시스템 내의 모든 파일을 정리하고  그에 관한 정보를 제공하는 디렉터리 구조로 구성

파일 시스템은 디바이스 위에 구성

* 파일 시스템의 기능을 설명
* 파일 시스템 인터페이스의 특징을 기술
* 접근 방법, 파일 공유 파일 잠금, 디렉터리 구조를 포함한 파일 시스템 설계의 절충안

파일 시스템 보호에 대해서 탐구

## 파일 개념

정보에 대한 일관된 논리적 관점 저장장치의 물리적 특성을 추상화하여 논리적 저장단위

* 소스 프로그램
* 목적 프로그램
* 실행 프로그램
* 숫자 자료
* 텍스트
* 급료 레코드
* 그래픽 이미지
* 소리

### 파일 속성

* 이름 : 사람이 읽을 수 있는 형태의 유일한 정보
* 식별자: 파일내의 파일 식별자
* 타입: extension?
* 위치: 포인터
* 크기: 크기
* 보호: 접근 제어 정보
* 시간 날짜 사용자 식별: 생성, 사용, 변경에 대한 정보

### 파일 연산
파일 이란 추상적인 데이터 타입

* 파일 생성: 파일 시스템내의 공간 / 디렉터리에 만들어져야함
* 파일 쓰기: 이름 기록될 정보, 쓰기 포인터
* 파일 읽기: 이름,  읽을 블록 / 읽기 포인터 / 현재 파일 위치 포인터를 가지고 있음 <- 공간 절약, 시스템 복잡성 감소
* 파일 안에서의 위치 재설정: 파일 탐색
* 파일 삭제: 공간 방출, 디렉토리 항목 삭제
* 파일 절단: 파일 길이 0 파일 공간 해제 (빠른 포맷 같은 느낌?)

open 시스템 호출

open-file table - indexing for file map

파일 이름이 아닌 포인터를 입출력 연산에 사용 -> 탐색과정을 피하고 시스템 호출 인터페이스를 단순화

프로세스별 테이블

* 각 프로세스가 연 모든 파일들을 기록

프로세스별 테이블은 범시스템 오픈 파일 테이블을 가리킴

범 시스템 테이블: 
* 프로세스에 독립된 정보 , 디스크 상의 파일 위치, 접근 날짜 , 파일 크기

프로세스 오픈 테이블-> 범 시스템 오픈 테이블
 
open() -> open_count++

close() -> open_count--

open count == 0 means file doesn't used
=> remove file pointer from open-file table

오픈 파일 관련된 정보

파일 포인터 : 가장 최근의 읽기 쓰기 위치

파일 오픈 계수: 사용하지 않을 경우 open-file table에서 삭제 -> 이 공간을 재사용하기 위함

파일 디스크 위치: 메모리에 저장

접근 권한: 하나의 접근 모드로 엶 -> 한번 오픈 파일에 등록된 접근권한은 후속 요구를 허용 / 불허

### 파일 타입
파일 타입을 인식하고 지원할 것인지 결정 하는 것

응용프로그램이 조작하는 파일들에 대한 힌트


### 파일 구조
파일 타입을 사용하여 파일의 내부구조 형태를 짐작할 수 있다.

### 파일의 내부 구조

내부적으로 한 파일 내의 특정 오프셋을 찾는 것은 복잡
섹터의 크기에 의해 결정되는 블록 크기를 가짐
-> 한 블록 단위로 실행되며 모든 시스크 블록들은 동일한 크기를 가짐

물리 레코드의 길이는 원하는 논리 레코드의 크기와 일치 하지 않는 경우가 일반적
논리 레코드의 길이는 매우 다양하며 여러 논리 레코드를 하나의 물리 레코드에 패킹하는 것이 이 차이를 해결하는 일반적인 해결책

블록 단위로 처리할 경우 내부단편화 현상이 있음
블록이 클 수록 이러한 문제는심화됨

## 접근 방법

### 순차 접근
가장 간단한 방법
read next, write next 컴파일러는 이러한 형식으로 파일에 접근

### 직접 접근
또는 상대접근이라 부름

파일 고정길이의 논리 레코드들로 구성되고 특별한 순서 없이 빠르게 레코드를 읽고 쓸 수 있다.

디스크 모델에 기반, 디스크가 무작위 파일 블록에 임의적 접근을 허용

대규모 데이터베이스가 이러한 유형

직접 접근으로 순차 접근 흉내는 매우 간단함

순차 접근 -> 직접 접근 너무 비효율적 깔끔하지도 않음

### 기타 접근 방법
index시스템 -> DB를 생각하면 간단할 듯


## 디렉터리와 디스크 구조

파티션은 개별 파일 시스템의 크기를 제한하거나 하나의 디스크에 여러개의 파일 시스템을 사용하거나 우분투에서 하는 그런 모든 것으로 사용할때 용하다.

파티션은 또한 slice 또는 미니디스크 등으로 다양하게 불림

임의의 개체를 볼륨이라 부르고 이는 장치의 부분 집합, 전체 장치 또는 집합으로 연결된 다수의 장치 일 수 있다

각 논리적 가상 디스크로 취급 가능

볼륨은 하나 이상의 운영체제를 부팅하고 실행할 수 있도록 여러 개의 운영 체제를 저장 할 수 있다.

아래는 윈도우의 볼륨에 관련된 도움말


```
파일 시스템으로 포맷된 하드 디스크 상의 저장 영역입니다.
볼륨에는 드라이브 문자가 할당됩니다.
단일 하드 디스크에 여러 개의 볼륨이 있을 수 있고 일부 볼륨은 여러 개의 하드 디스크로 스팬될 수 있습니다.
```

### 저장 장치의 구조

* tmpfs: 휘발성 주 메모리에 생성되고 시스템이 재부팅되거나 고장났을 대 파일 시스템의 내용이 지워지는 임시 파일 시스템
* objfs: 디버거가 커널 심벌을 접근할 수 있게 하는 가상 파일 시스템
* cfts: 시스템이 부트될 때 시작하여 운영체제가 실행되는 동안 실행되어야 하는 프로세스들을 관리하기 위한 contract 정보를 저장하기 위한 가상 파일 시스템
* lofs: 한 파일 시스템 대신에 다른 파일 시스템을 접근할 수 있게 하는 loop back파일 시스템 
* procfs: 모든 프로세스에 관한 정보를 파일 시스템 형태로 보여주는 가상 파일 시스템
* ufs, zfs: 범용 파일 시스템

### 디렉토리 개관
디렉토리는 "파일 이름을 해당 디릭토리 항목으로 변환해주는" 심벌 테이블
각 디렉토리에 실행 될 수 있는 연산들을 중심으로 생각할 필요가 있음

* 파일 찾기 
* 파일 생성
* 디렉토리 나열
* 파일의 재명명
* 파일 시스템의 순회

### 1단계 디렉토리 
모든 파일이 디렉토리 밑에 존재
각 파일은 유일한 이름을 가져야함

### 2단계 디렉토리 
MFD -> UFD -> file
* MFD: Master File Directory
* UFD: User File Directory

### 트리 구조 디렉토리
각 프로세스는 현재 디렉토리를 가지고 있다. ('./')

상대 경로와, 절대경로가 있다.

트리구조에서 디렉토리 삭제 시 하위의 모든 데이터를 삭제해야한다.

MS-DOS의 경우에는 이러한 경우(하위에 데이터가 있는 경우) 삭제를 막고 있다.

UNIX 시스템에서는 rm 으로 하위의 모든 데이터를 삭제해준다고 하는데 우분투에서는 이를 막고 있음을 볼 수 있다.

### 비순환 그래프 디렉토리
흔히 말하는 link의 구조를 상상하면 쉬울듯
다른 파일을 가리키는 포인터 

실질적 파일이 삭제되었을 때 어떻게 할 것인가!
1. unix, ms-dos는 이를 유저에게 판단을 맡김
2. 모든 참조가 지워질때까지 원본파일을 보존 
이 경우 파일에 대한 링크 테이블이 필요함 -> 테이블의 length가 0 이면 원본 파일을 삭제 할 수 있도록 해준다.

### 일반 그래프 디렉토리
링크의 순환을 해결 하기 위함
디스크 공간을 재할당 될 수 있을 대는 결정하기 위해 가비지 컬렉션이 필요함 -> 접근 가능한 모든 것을 표시, 표시되지 않은 것을 수집하여 사용가능한 공간 리스트에 추가

## 파일 시스템 마운팅
각 볼륨들을 사용 할 수 있도록 마운팅 
마운팅 포인트: 루트 파일 시스템이 사용할 수 있는 물리적 위치

## 파일 공유
읽고 쓰기 간의 파일 공유 

### 다수의 사용자
공유와 보호를 위해 
소유자 / 그룹 같은 것을 사용 

### 원격 파일 시스템 
1. FTP 같은 네트워크 프로토콜 : 익명접근
2. 원격 디렉토리에 접근 할 수 있는 분산 파일 시스템 (DFS)
3. WWW <- 첫번째 방법으로의 회귀

#### 클라이언트 서버 모델 
서버의 도용 및 보장이 있고, 이에 대한 인증 부분이 해결되어야함

암호화된 키를 통한 클라이언트 인증

#### 분산 정보 시스템
클라이언트 - 서버 시스템을 쉽게 관리하기 위해 분산 정보 시스템 또는 분산 네이밍 서비스가 단일화된 접근을 제공함 
그 중 하나인 도메인 네임 시스템은 호스트이름 -> 네트워크 주소로 변환하는 서비스를 제공 

로그인을 통한 인증 관리

경랑 디렉토리 접근 프로토콜 
[참고 사진](http://directory.apache.org/apacheds/basic-ug/images/fromX500toLDAP.png)

#### 고장 모드 
특정 정보의 상태 정보를 클라 / 서버에서 모두 유지
stateless stateful에 관련된 pdf(https://www.cs.swarthmore.edu/~newhall/cs85/s08/trilok.pdf)

### 일관성의 의미

동시성과 관련 

공유하고 있는 유저들의 파일이 일관되어야함

파일 세션을 만들어서 관리하기
#### UNIX의의미

* 열린 파일에 대한 사용자의 쓰기는 동일 파일을 연 다른 사용자에게 즉시 보인다.
* 파일 내의 포인터를 공유하는 공유 모드가 있다.
이 포인터를 전진 시키면 모든 유저에게 영향을 미친다.

#### 세션 의미






